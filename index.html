<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Post Generator</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f3f4f6;
            color: #111827;
            min-height: 100vh;
            padding: 36px 20px 72px;
        }

        .container { max-width: 680px; margin: 0 auto; }

        /* Header */
        .header { margin-bottom: 28px; }
        .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #0a66c2;
            display: flex;
            align-items: center;
            gap: 9px;
        }
        .header p { color: #6b7280; font-size: 14px; margin-top: 5px; }

        /* Cards */
        .card {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 20px 24px;
            margin-bottom: 12px;
        }

        .card-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        /* Fields */
        .field { margin-bottom: 16px; }
        .field:last-child { margin-bottom: 0; }
        .field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 520px) { .field-row { grid-template-columns: 1fr; } }

        input[type="password"],
        input[type="text"],
        select,
        textarea {
            width: 100%;
            font-family: inherit;
            font-size: 14px;
            color: #111827;
            background: #f9fafb;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            padding: 9px 12px;
            transition: border-color 0.15s, background 0.15s;
            outline: none;
        }
        input[type="password"]:focus,
        input[type="text"]:focus,
        select:focus,
        textarea:focus { border-color: #0a66c2; background: #fff; }

        textarea { resize: vertical; line-height: 1.55; }
        select { cursor: pointer; }

        .input-wrap { position: relative; }
        .input-wrap input { padding-right: 58px; }
        .show-hide {
            position: absolute;
            right: 0; top: 0; bottom: 0;
            padding: 0 12px;
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            font-size: 12px;
            font-weight: 500;
            font-family: inherit;
        }
        .show-hide:hover { color: #374151; }

        .key-saved {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #16a34a;
            margin-top: 5px;
        }

        /* Upload */
        .upload-drop {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
            background: #f9fafb;
        }
        .upload-drop:hover { border-color: #0a66c2; background: #eff6ff; }
        .upload-drop.loaded { border-color: #16a34a; background: #f0fdf4; }
        .upload-drop input[type="file"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .up-icon { font-size: 20px; margin-bottom: 4px; }
        .up-main { font-size: 13px; font-weight: 500; color: #374151; }
        .up-sub { font-size: 11px; color: #9ca3af; margin-top: 2px; }
        .posts-badge {
            display: inline-flex;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            background: #dcfce7;
            color: #166534;
            border-radius: 999px;
            padding: 2px 8px;
            margin-left: 6px;
        }

        /* Button */
        .btn-gen {
            width: 100%;
            padding: 12px;
            background: #0a66c2;
            color: white;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
            margin-top: 4px;
        }
        .btn-gen:hover:not(:disabled) { background: #004182; }
        .btn-gen:active:not(:disabled) { transform: scale(0.99); }
        .btn-gen:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; }

        /* Error */
        .error-box {
            display: none;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 13px;
            color: #b91c1c;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .error-box.show { display: block; }

        /* Progress */
        .progress-card { display: none; }
        .progress-card.show { display: block; }
        .progress-track {
            height: 5px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0a66c2 0%, #38bdf8 100%);
            border-radius: 999px;
            width: 0%;
            transition: width 0.4s ease;
        }
        .progress-status { font-size: 13px; color: #6b7280; text-align: center; }

        /* Output */
        .output-card { display: none; }
        .output-card.show { display: block; }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .output-actions { display: flex; align-items: center; gap: 8px; }

        .char-count { font-size: 12px; color: #9ca3af; }
        .char-count.over { color: #dc2626; font-weight: 600; }

        .btn-sm {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-copy {
            background: #0a66c2;
            color: white;
            border: 1.5px solid #0a66c2;
        }
        .btn-copy:hover { background: #004182; border-color: #004182; }
        .btn-copy.copied { background: #16a34a; border-color: #16a34a; }

        .btn-retry {
            background: white;
            color: #374151;
            border: 1.5px solid #d1d5db;
        }
        .btn-retry:hover { border-color: #9ca3af; }
        .btn-retry:disabled { opacity: 0.4; cursor: not-allowed; }

        .output-divider { height: 1px; background: #f3f4f6; margin-bottom: 16px; }

        .output-text {
            font-size: 15px;
            line-height: 1.65;
            white-space: pre-wrap;
            color: #111827;
            min-height: 80px;
        }

        /* Streaming cursor */
        .cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: #0a66c2;
            margin-left: 1px;
            vertical-align: text-bottom;
            animation: blink 0.75s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .privacy-note {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 6px;
        }

        /* CSV help */
        .csv-help {
            margin-top: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            font-size: 13px;
        }
        .csv-help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 9px 12px;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
            background: #f9fafb;
            user-select: none;
        }
        .csv-help-header:hover { color: #374151; background: #f3f4f6; }
        .csv-help-arrow { font-size: 11px; transition: transform 0.2s; }
        .csv-help-arrow.open { transform: rotate(90deg); }
        .csv-help-body {
            display: none;
            padding: 14px 14px 12px;
            border-top: 1px solid #e5e7eb;
            background: #fff;
        }
        .csv-help-body p { color: #374151; margin-bottom: 12px; line-height: 1.5; }
        .csv-help-body strong { font-weight: 600; }

        .csv-preview {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .csv-preview-header {
            background: #f3f4f6;
            padding: 5px 10px;
            font-weight: 700;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .csv-preview-row {
            padding: 6px 10px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .csv-preview-more {
            padding: 5px 10px;
            color: #9ca3af;
            font-style: italic;
        }

        .csv-tips {
            list-style: none;
            margin-bottom: 12px;
        }
        .csv-tips li {
            color: #6b7280;
            padding: 3px 0 3px 16px;
            position: relative;
            line-height: 1.5;
        }
        .csv-tips li::before {
            content: '¬∑';
            position: absolute;
            left: 5px;
            color: #9ca3af;
        }
        .csv-tips code {
            background: #f3f4f6;
            padding: 1px 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
            color: #374151;
        }

        .csv-download-btn {
            display: inline-block;
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #374151;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
        }
        .csv-download-btn:hover { background: #e5e7eb; }

        /* AI warning */
        .ai-warning {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 11px 14px;
            margin-top: 12px;
            font-size: 13px;
            color: #92400e;
            line-height: 1.5;
        }
        .ai-warning-icon { font-size: 15px; flex-shrink: 0; margin-top: 1px; }
        .ai-warning strong { font-weight: 600; }

        .cost-line {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 10px;
            text-align: right;
        }

        .field-explainer {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* API key tooltip */
        .key-tooltip-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-left: 5px;
            vertical-align: middle;
        }
        .key-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 15px;
            height: 15px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
            cursor: default;
            line-height: 1;
        }
        .key-tooltip-wrap:hover .key-tooltip { display: block; }
        .key-tooltip {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 240px;
            background: #1f2937;
            color: #f9fafb;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.55;
            padding: 12px 14px;
            border-radius: 8px;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            pointer-events: none;
            text-transform: none;
            letter-spacing: 0;
        }
        .key-tooltip strong { color: #fff; font-weight: 600; }
        .key-tooltip em { color: #93c5fd; font-style: normal; }
        .key-tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 10px;
            width: 10px;
            height: 10px;
            background: #1f2937;
            transform: rotate(45deg);
        }
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <h1>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="#0a66c2" style="flex-shrink:0">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
            Post Generator
        </h1>
        <p>Upload your past posts, describe a topic ‚Äî get a post in your voice.</p>
    </div>

    <!-- Config -->
    <div class="card">
        <div class="card-label">Setup</div>
        <div class="field-row">
            <div class="field">
                <label for="api-key">
                    Claude API Key
                    <span class="key-tooltip-wrap">
                        <span class="key-info-icon">?</span>
                        <span class="key-tooltip">
                            <strong>What is this?</strong>
                            This is your personal API key for Claude (Anthropic's AI). It lets the tool generate posts directly from your browser ‚Äî no middleman.<br><br>
                            <strong>How to get one:</strong><br>
                            1. Go to <em>console.anthropic.com</em><br>
                            2. Sign in or create a free account<br>
                            3. Click <em>API Keys</em> in the left sidebar<br>
                            4. Click <em>Create Key</em> and copy it<br><br>
                            Paste it here ‚Äî it starts with <em>sk-ant-</em>
                        </span>
                    </span>
                </label>
                <div class="input-wrap">
                    <input type="password" id="api-key" placeholder="sk-ant-..." autocomplete="off" spellcheck="false">
                    <button class="show-hide" type="button" onclick="toggleKey(this)">Show</button>
                </div>
                <div id="key-status"></div>
                <div class="privacy-note">Saved in your browser only. Never sent anywhere except Anthropic.</div>
            </div>

            <div class="field">
                <label for="model">Model</label>
                <select id="model">
                    <option value="claude-sonnet-4-6">Sonnet 4.6 ‚Äî faster (~$0.02/post)</option>
                    <option value="claude-opus-4-6">Opus 4.6 ‚Äî best quality (~$0.10/post)</option>
                    <option value="claude-haiku-4-5-20251001">Haiku 4.5 ‚Äî fastest (~$0.005/post)</option>
                </select>
            </div>
        </div>

        <div class="field">
            <label>Past Posts <span id="badge-wrap"></span></label>
            <p class="field-explainer">Upload posts you've written to improve tone of voice and add context. This acts as your brain ‚Äî the tool pulls from it to match how you write and think.</p>
            <div class="upload-drop" id="upload-drop">
                <input type="file" id="csv-file" accept=".csv,.txt" onchange="handleUpload(event)">
                <div class="up-icon" id="up-icon">üìÇ</div>
                <div class="up-main" id="up-main">Click to upload CSV</div>
                <div class="up-sub">One post per row ¬∑ uploads persist until you replace them</div>
            </div>
            <div class="csv-help">
                <div class="csv-help-header" onclick="toggleHelp()">
                    <span>How to format your CSV</span>
                    <span class="csv-help-arrow" id="help-arrow">‚ñ∏</span>
                </div>
                <div class="csv-help-body" id="help-body">
                    <p>Create a spreadsheet with a single column of your LinkedIn posts ‚Äî one post per row. Export it as a <strong>.csv</strong> file.</p>
                    <div class="csv-preview">
                        <div class="csv-preview-header">
                            <span>post_text</span>
                        </div>
                        <div class="csv-preview-row">I spent 3 years building the wrong product. Here's what I learned...</div>
                        <div class="csv-preview-row">Most people think cold outreach doesn't work. They're wrong. It just requires a different approach...</div>
                        <div class="csv-preview-row">We closed our biggest deal last month ‚Äî $180k ARR. The entire sales process took 9 days...</div>
                        <div class="csv-preview-more">+ your posts below</div>
                    </div>
                    <ul class="csv-tips">
                        <li>The first row can be a header (e.g. <code>post_text</code>) ‚Äî it'll be skipped automatically</li>
                        <li>Posts with commas or line breaks are fine as long as they're wrapped in quotes</li>
                        <li>More posts = better voice matching. Aim for 30+ if you have them</li>
                        <li>In Google Sheets: <strong>File ‚Üí Download ‚Üí CSV</strong></li>
                    </ul>
                    <a class="csv-download-btn" onclick="downloadExample()">‚Üì Download example CSV</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Idea Input -->
    <div class="card">
        <div class="card-label">Your Idea</div>
        <div class="field">
            <label for="topic">What do you want to write about?</label>
            <textarea id="topic" rows="7" placeholder="Give as much detail as you can. The more you add, the better the output.&#10;&#10;Include:&#10;‚Äî The core idea, story, or lesson&#10;‚Äî Any numbers, results, or specifics&#10;‚Äî The hook you want if you have one (the first 1-2 lines)&#10;‚Äî The tone or angle you're going for"></textarea>
        </div>
        <button class="btn-gen" id="gen-btn" type="button" onclick="generate()">Generate Post</button>
        <div class="error-box" id="error-box"></div>
    </div>

    <!-- Progress -->
    <div class="card progress-card" id="progress-card">
        <div class="progress-track">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-status" id="progress-status">Analyzing your writing style...</div>
    </div>

    <!-- Output -->
    <div class="card output-card" id="output-card">
        <div class="output-header">
            <div class="card-label" style="margin-bottom:0">Generated Post</div>
            <div class="output-actions">
                <span class="char-count" id="char-count"></span>
                <button class="btn-sm btn-retry" id="retry-btn" type="button" onclick="generate()" disabled>‚Ü∫ Retry</button>
                <button class="btn-sm btn-copy" id="copy-btn" type="button" onclick="copyPost()">Copy</button>
            </div>
        </div>
        <div class="output-divider"></div>
        <div class="output-text" id="output-text"></div>
        <div class="cost-line" id="cost-line"></div>
        <div class="ai-warning">
            <span class="ai-warning-icon">‚ö†Ô∏è</span>
            <span><strong>This is a first draft, not a final post.</strong> AI output almost always contains AI-isms ‚Äî phrases that sound unnatural, over-polished, or generic. Always read through, rewrite in your own words, and edit before publishing.</span>
        </div>
    </div>

</div>
<script>
    let posts = [];
    let generating = false;

    // Pricing per million tokens (input / output)
    const PRICING = {
        'claude-opus-4-6':           { input: 15,   output: 75  },
        'claude-sonnet-4-6':         { input: 3,    output: 15  },
        'claude-haiku-4-5-20251001': { input: 0.80, output: 4   },
    };

    // Restore saved API key
    const keyInput = document.getElementById('api-key');
    (() => {
        const saved = localStorage.getItem('li_gen_key');
        if (saved) { keyInput.value = saved; showKeySaved(); }
    })();

    keyInput.addEventListener('blur', () => {
        const v = keyInput.value.trim();
        if (v) { localStorage.setItem('li_gen_key', v); showKeySaved(); }
        else { localStorage.removeItem('li_gen_key'); document.getElementById('key-status').innerHTML = ''; }
    });

    function showKeySaved() {
        document.getElementById('key-status').innerHTML = '<span class="key-saved">‚úì Saved</span>';
    }

    function toggleKey(btn) {
        keyInput.type = keyInput.type === 'password' ? 'text' : 'password';
        btn.textContent = keyInput.type === 'password' ? 'Show' : 'Hide';
    }

    // CSV parser ‚Äî handles quoted fields, multi-column (uses first col only)
    function parseCSV(text) {
        const rows = [];
        let cell = '';
        let inQuote = false;
        let pastFirst = false;

        for (let i = 0; i <= text.length; i++) {
            const c = i < text.length ? text[i] : '\n';
            const next = i + 1 < text.length ? text[i + 1] : '';

            if (c === '"') {
                if (inQuote && next === '"') { if (!pastFirst) cell += '"'; i++; }
                else inQuote = !inQuote;
            } else if (c === ',' && !inQuote) {
                pastFirst = true;
            } else if ((c === '\n' || (c === '\r' && next !== '\n')) && !inQuote) {
                const t = cell.trim();
                if (t.length > 20) rows.push(t);
                cell = ''; pastFirst = false;
            } else if (c === '\r') {
                // skip \r in \r\n
            } else if (!pastFirst) {
                cell += c;
            }
        }
        return rows;
    }

    function looksLikeHeader(s) {
        const t = s.toLowerCase().trim();
        const words = ['post', 'content', 'text', 'body', 'message', 'caption', 'copy', 'posts', 'post text'];
        return words.includes(t) || (t.split(' ').length <= 3 && t.length < 30 && !/[.!?]$/.test(t));
    }

    function setUploadUI(filename, count) {
        document.getElementById('upload-drop').classList.add('loaded');
        document.getElementById('up-icon').textContent = '‚úÖ';
        document.getElementById('up-main').textContent = filename;
        document.getElementById('badge-wrap').innerHTML =
            `<span class="posts-badge">‚úì ${count} posts</span>`;
    }

    // Restore saved posts on load
    (() => {
        const saved = localStorage.getItem('li_gen_posts');
        const savedMeta = localStorage.getItem('li_gen_posts_meta');
        if (saved && savedMeta) {
            posts = JSON.parse(saved);
            const { filename } = JSON.parse(savedMeta);
            setUploadUI(filename, posts.length);
        }
    })();

    function handleUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
            let parsed = parseCSV(evt.target.result);
            if (parsed.length > 0 && looksLikeHeader(parsed[0])) parsed = parsed.slice(1);
            posts = parsed;

            localStorage.setItem('li_gen_posts', JSON.stringify(posts));
            localStorage.setItem('li_gen_posts_meta', JSON.stringify({ filename: file.name }));

            setUploadUI(file.name, posts.length);
        };
        reader.readAsText(file);
    }

    // Progress helpers
    function setProgress(pct, msg) {
        document.getElementById('progress-fill').style.width = pct + '%';
        document.getElementById('progress-status').textContent = msg;
    }
    function showProgress() { document.getElementById('progress-card').classList.add('show'); }
    function hideProgress() { document.getElementById('progress-card').classList.remove('show'); }

    function showError(msg) {
        const el = document.getElementById('error-box');
        el.textContent = msg;
        el.classList.add('show');
    }
    function hideError() { document.getElementById('error-box').classList.remove('show'); }

    function updateCharCount(n) {
        const el = document.getElementById('char-count');
        el.textContent = `${n.toLocaleString()} / 3,000 chars`;
        el.className = 'char-count' + (n > 3000 ? ' over' : '');
    }

    async function generate() {
        if (generating) return;
        hideError();

        const apiKey = keyInput.value.trim();
        const topic = document.getElementById('topic').value.trim();
        const model = document.getElementById('model').value;

        if (!apiKey) return showError('Please enter your Claude API key.');
        if (!topic) return showError('Please describe what you want to write about.');
        if (posts.length === 0) return showError('Please upload your CSV of past posts first.');

        generating = true;
        document.getElementById('gen-btn').disabled = true;
        document.getElementById('retry-btn').disabled = true;

        showProgress();
        setProgress(10, 'Reading your posts...');

        // Use up to 30 posts ‚Äî take from throughout the list for variety
        const sample = posts.length > 30
            ? posts.filter((_, i) => i % Math.floor(posts.length / 30) === 0).slice(0, 30)
            : posts;

        const postsBlock = sample.join('\n\n---\n\n');

        setProgress(30, 'Building your voice profile...');

        const system = `You are a LinkedIn ghostwriter. Your task is to write a LinkedIn post that sounds exactly like this person based on their historical posts. Study these examples carefully and mirror their tone, structure, and personality:

${postsBlock}

Core Voice Characteristics to identify and replicate:
- How systematic or intuitive their thinking is; how they break down problems
- Whether they're grounded in specifics: numbers, timeframes, concrete examples
- Their perspective: practitioner vs. theorist, tactical vs. strategic
- Their sentence rhythm ‚Äî variation between short punchy lines and longer explanatory ones

Writing Guidelines:
- Be direct, systematic, and educational
- Include specific numbers, timeframes, and frameworks where the topic calls for it
- Avoid generic buzzwords, hype language, and theatrical sentence fragments
- Use natural sentence variation ‚Äî NOT machine-gun short sentences
- Don't include any bold (no **asterisks**) or --- section separators

Structure (max 3,000 characters total ‚Äî stay under this hard limit):
Hook ‚Äî Start with a specific result, contrarian take, or framework promise (data + framework promise works best)
Context ‚Äî Set up the problem with a specific example or situation
Framework ‚Äî Deliver the core system with numbered steps and ‚Üí bullets for sub-points
Proof ‚Äî Back it up with specific results, data, or additional examples
Bottom Line ‚Äî Summarize key points with > bullets
Soft CTA ‚Äî End with a low-pressure invitation (DM me, drop a comment, etc.)

Formatting Rules:
- Numbered lists for sequential steps
- Arrow bullets (‚Üí) for non-sequential options or examples
- Parentheticals to add voice: "(this is the part most people skip)" or "(diagnose before prescribing)"
- Mix list types strategically
- Use "Here's the framework:" or "Why this works:" as transitions

Output:
Return ONLY the LinkedIn post text, ready to copy and paste. Write as this person, not about them. No explanations or meta-commentary.`;

        const userMsg = `Write a new LinkedIn post on this topic: ${topic}`;

        setProgress(50, 'Sending to Claude...');

        // Hide previous output while regenerating
        document.getElementById('output-card').classList.remove('show');

        try {
            const res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'content-type': 'application/json',
                    'anthropic-dangerous-direct-browser-access': 'true',
                },
                body: JSON.stringify({
                    model,
                    max_tokens: 1500,
                    stream: true,
                    system,
                    messages: [{ role: 'user', content: userMsg }],
                }),
            });

            if (!res.ok) {
                let msg = `API error ${res.status}`;
                try { const d = await res.json(); msg = d.error?.message || msg; } catch (_) {}
                throw new Error(msg);
            }

            setProgress(65, 'Generating...');

            const outputText = document.getElementById('output-text');
            const outputCard = document.getElementById('output-card');
            outputText.innerHTML = '';
            outputCard.classList.add('show');

            // Blinking cursor
            const cursor = document.createElement('span');
            cursor.className = 'cursor';
            outputText.appendChild(cursor);

            const reader = res.body.getReader();
            const dec = new TextDecoder();
            let buf = '';
            let full = '';
            let inputTokens = 0;
            let outputTokens = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buf += dec.decode(value, { stream: true });
                const lines = buf.split('\n');
                buf = lines.pop() ?? '';

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    const raw = line.slice(6).trim();
                    if (raw === '[DONE]') continue;
                    try {
                        const evt = JSON.parse(raw);
                        if (evt.type === 'message_start') {
                            inputTokens = evt.message?.usage?.input_tokens || 0;
                        } else if (evt.type === 'message_delta') {
                            outputTokens = evt.usage?.output_tokens || 0;
                        } else if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
                            full += evt.delta.text;
                            outputText.textContent = full;
                            outputText.appendChild(cursor);
                            updateCharCount(full.length);
                            const pct = Math.min(95, 65 + (full.length / 1400) * 30);
                            setProgress(pct, 'Writing...');
                        }
                    } catch (_) {}
                }
            }

            cursor.remove();
            outputText.textContent = full;
            updateCharCount(full.length);
            setProgress(100, 'Done ‚úì');
            showCost(model, inputTokens, outputTokens);
            setTimeout(hideProgress, 800);

        } catch (err) {
            hideProgress();
            showError(err.message);
            console.error(err);
        } finally {
            generating = false;
            document.getElementById('gen-btn').disabled = false;
            document.getElementById('retry-btn').disabled = false;
        }
    }

    function showCost(model, inputTokens, outputTokens) {
        const p = PRICING[model];
        if (!p || (!inputTokens && !outputTokens)) return;
        const cost = (inputTokens * p.input + outputTokens * p.output) / 1_000_000;
        const el = document.getElementById('cost-line');
        el.textContent = `Cost: $${cost.toFixed(4)} ¬∑ ${inputTokens.toLocaleString()} input tokens ¬∑ ${outputTokens.toLocaleString()} output tokens`;
    }

    function toggleHelp() {
        const body = document.getElementById('help-body');
        const arrow = document.getElementById('help-arrow');
        const open = body.style.display === 'block';
        body.style.display = open ? 'none' : 'block';
        arrow.classList.toggle('open', !open);
    }

    function downloadExample() {
        const csv = `post_text
"I spent 3 years building the wrong product. Here's what I learned about finding product-market fit the hard way..."
"Most people think cold outreach doesn't work. They're wrong. It just requires a completely different approach than what you've been taught..."
"We closed our biggest deal last month ‚Äî $180k ARR. The entire sales process took 9 days. Here's exactly how we did it..."
"Hiring your first 10 people is the most important thing you'll do as a founder. I've made every mistake possible. Here's what I'd do differently..."
"Everyone talks about scaling. Nobody talks about what breaks when you do. Last year we went from $1M to $4M ARR and almost destroyed the company in the process..."`;

        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'example-posts.csv';
        a.click();
    }

    async function copyPost() {
        const text = document.getElementById('output-text').textContent;
        const btn = document.getElementById('copy-btn');
        try {
            await navigator.clipboard.writeText(text);
        } catch (_) {
            const ta = document.createElement('textarea');
            ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
            document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); ta.remove();
        }
        btn.textContent = '‚úì Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2500);
    }
</script>
</body>
</html>
